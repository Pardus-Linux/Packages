From 598784a7ef75a7fb7894b7350902916542dc1878 Mon Sep 17 00:00:00 2001
From: Fatih Arslan <ftharsln@gmail.com>
Date: Thu, 16 Dec 2010 16:40:54 +0200
Subject: [PATCH] KAuth implementation to save layout and variant settings system wide

---
 kcontrol/keyboard/CMakeLists.txt      |   15 +++++++
 kcontrol/keyboard/helper.cpp          |   70 +++++++++++++++++++++++++++++++++
 kcontrol/keyboard/helper.h            |   17 ++++++++
 kcontrol/keyboard/kcm_keyboard.cpp    |   14 +++++++
 kcontrol/keyboard/kcm_keyboard.h      |    3 +
 kcontrol/keyboard/kcmkeyboard.actions |    9 ++++
 kcontrol/keyboard/keyboard_config.cpp |   29 +++++++++++++-
 kcontrol/keyboard/keyboard_config.h   |    1 +
 8 files changed, 157 insertions(+), 1 deletions(-)
 create mode 100644 kcontrol/keyboard/helper.cpp
 create mode 100644 kcontrol/keyboard/helper.h
 create mode 100644 kcontrol/keyboard/kcmkeyboard.actions

diff --git a/kcontrol/keyboard/CMakeLists.txt b/kcontrol/keyboard/CMakeLists.txt
index 197f4f8..5056965 100644
--- a/kcontrol/keyboard/CMakeLists.txt
+++ b/kcontrol/keyboard/CMakeLists.txt
@@ -124,6 +124,21 @@ target_link_libraries(kcm_keyboard
     ${KDE4_KIO_LIBS} ${X11_Xkbfile_LIB} ${X11_LIBRARIES}
 )
 
+
+
+#### KAuth helper and actions ####
+kde4_add_executable(kcmkeyboardhelper helper.cpp)
+target_link_libraries(kcmkeyboardhelper ${KDE4_KDECORE_LIBS})
+install(TARGETS kcmkeyboardhelper DESTINATION ${LIBEXEC_INSTALL_DIR})
+
+kde4_install_auth_helper_files(kcmkeyboardhelper org.kde.kcontrol.kcmkeyboard root)
+
+kde4_install_auth_actions(org.kde.kcontrol.kcmkeyboard kcmkeyboard.actions)
+
+
+
+
+
 install(TARGETS kcm_keyboard DESTINATION ${PLUGIN_INSTALL_DIR} )
 
 install( FILES kcm_keyboard.desktop DESTINATION ${SERVICES_INSTALL_DIR} )
diff --git a/kcontrol/keyboard/helper.cpp b/kcontrol/keyboard/helper.cpp
new file mode 100644
index 0000000..5595c39
--- /dev/null
+++ b/kcontrol/keyboard/helper.cpp
@@ -0,0 +1,70 @@
+#include "helper.h"
+#include <iostream>
+#include <QStringList>
+#include <QFile>
+#include <QTextStream>
+#include <QDebug>
+
+ActionReply Helper::createReply(int code, const QVariantMap *returnData)
+{
+    ActionReply reply;
+
+    if (code) {
+        reply = ActionReply::HelperError;
+        reply.setErrorCode(code);
+    } else {
+        reply = ActionReply::SuccessReply;
+    }
+
+    if (returnData)
+        reply.setData(*returnData);
+
+    return reply;
+}
+
+
+bool Helper::writeKeyboard(const QString &layouts, const QString &variants)
+{
+    QString xorgFile = "/etc/X11/xorg.conf.d/00-configured-keymap.conf";
+
+    QString xorgContent;
+    xorgContent =   "# This file is generated by KCM Keyboard Module.\n"
+                    "# If you want to change settings in this file, edit\n"
+                    "# the file 10-keyboard.conf in the same directory.\n\n"
+                    "Section \"InputClass\"\n"
+                    "       Identifier\t\"Configured Keymap\"\n"
+                    "       MatchisKeyboard\t\"on\"\n"
+                    "       MatchTag\t\"use_configured_keymap\"\n\n"
+                    "       Option\t\"xkb_layout\"\t\"" + layouts + "\"\n"
+                    "       Option\t\"xkb_variant\"\t\"" + variants + "\"\n"
+                    "EndSection\n";
+
+    // open file to write
+    QFile file(xorgFile);
+    if( !file.open( QIODevice::WriteOnly | QIODevice::Text)) {
+        qDebug() << "Failed to write.";
+        return false;
+    }
+
+    // content of fields is saved to the new file
+    QTextStream out(&file);
+    out << xorgContent;
+    file.close();
+
+    return true;
+}
+
+ActionReply Helper::managekeyboard(QVariantMap args)
+{
+    int code = 0;
+
+    QString layouts = args.value("layouts").toString();
+    QString variants = args.value("variants").toString();
+
+    code = (writeKeyboard(layouts,variants) ? 0 : WriteKeyboardError);
+    return createReply(code);
+}
+
+
+
+KDE4_AUTH_HELPER_MAIN("org.kde.kcontrol.kcmkeyboard", Helper)
diff --git a/kcontrol/keyboard/helper.h b/kcontrol/keyboard/helper.h
new file mode 100644
index 0000000..809a3f6
--- /dev/null
+++ b/kcontrol/keyboard/helper.h
@@ -0,0 +1,17 @@
+#include <kauth.h>
+#define WriteKeyboardError 1
+
+using namespace KAuth;
+
+class Helper : public QObject
+{
+    Q_OBJECT
+
+    public slots:
+        ActionReply managekeyboard(QVariantMap args);
+
+    private:
+        bool writeKeyboard(const QString &layouts, const QString &variants);
+        ActionReply createReply(int code, const QVariantMap *returnData = 0);
+
+};
diff --git a/kcontrol/keyboard/kcm_keyboard.cpp b/kcontrol/keyboard/kcm_keyboard.cpp
index 4e3cdaf..12739b6 100644
--- a/kcontrol/keyboard/kcm_keyboard.cpp
+++ b/kcontrol/keyboard/kcm_keyboard.cpp
@@ -23,6 +23,7 @@
 #include <kaboutdata.h>
 #include <kpluginfactory.h>
 #include <kpluginloader.h>
+#include <kmessagebox.h>
 
 #include <QtDBus/QDBusMessage>
 #include <QtDBus/QDBusConnection>
@@ -63,14 +64,18 @@ KCMKeyboard::KCMKeyboard(QWidget *parent, const QVariantList &/*args*/)
 
   keyboardConfig = new KeyboardConfig();
 
+  systemWide = new QCheckBox("Save settings system &wide");
+
   QVBoxLayout *layout = new QVBoxLayout(this);
   layout->setMargin(0);
   layout->setSpacing(KDialog::spacingHint());
 
   widget = new KCMKeyboardWidget(rules, keyboardConfig, componentData(), parent);
   layout->addWidget(widget);
+  layout->addWidget(systemWide);
 
   connect(widget, SIGNAL(changed(bool)), this, SIGNAL(changed(bool)));
+  connect(systemWide, SIGNAL(clicked(bool)), this, SIGNAL(changed(bool)));
 
 #ifdef DEFAULT_TAB
   widget->setCurrentIndex(DEFAULT_TAB);
@@ -110,6 +115,15 @@ void KCMKeyboard::save()
 	QDBusMessage message = QDBusMessage::createSignal(KEYBOARD_DBUS_OBJECT_PATH, KEYBOARD_DBUS_SERVICE_NAME, KEYBOARD_DBUS_CONFIG_RELOAD_MESSAGE);
     QDBusConnection::sessionBus().send(message);
 
+    if (systemWide->isChecked()) {
+        int replyErrorCode = keyboardConfig->saveSystemWide();
+        if (replyErrorCode != 0)
+            KMessageBox::error(this, i18n("KAuth returned an error code: %1", replyErrorCode));
+    };
+
+
+
+
 //    initializeKeyboardSettings();
 }
 
diff --git a/kcontrol/keyboard/kcm_keyboard.h b/kcontrol/keyboard/kcm_keyboard.h
index c88fe3d..64c9226 100644
--- a/kcontrol/keyboard/kcm_keyboard.h
+++ b/kcontrol/keyboard/kcm_keyboard.h
@@ -25,6 +25,7 @@
 class KCMKeyboardWidget;
 class KeyboardConfig;
 class Rules;
+class QCheckBox;
 
 class KCMKeyboard: public KCModule
 {
@@ -42,6 +43,8 @@ private:
 	Rules* rules;
 	KeyboardConfig* keyboardConfig;
 	KCMKeyboardWidget *widget;
+    QCheckBox *systemWide;
 };
 
+
 #endif /* KCM_KEYBOARD_H_ */
diff --git a/kcontrol/keyboard/kcmkeyboard.actions b/kcontrol/keyboard/kcmkeyboard.actions
new file mode 100644
index 0000000..408427b
--- /dev/null
+++ b/kcontrol/keyboard/kcmkeyboard.actions
@@ -0,0 +1,9 @@
+[Domain]
+Name=Keyboard Manager Control Module
+Icon=preferences-system-login
+
+[org.kde.kcontrol.kcmkeyboard.managekeyboard]
+Name=Save the Keyboard Manager settings
+Description=Administrator authorization is required to change the Keyboard Manager settings
+Policy=auth_admin
+Persistence=session
diff --git a/kcontrol/keyboard/keyboard_config.cpp b/kcontrol/keyboard/keyboard_config.cpp
index 1e1a670..f095f88 100644
--- a/kcontrol/keyboard/keyboard_config.cpp
+++ b/kcontrol/keyboard/keyboard_config.cpp
@@ -18,9 +18,13 @@
 
 #include "keyboard_config.h"
 
+#include "helper.h"
+
 #include <ksharedconfig.h>
 #include <kconfiggroup.h>
 #include <kdebug.h>
+#include <QMessageBox>
+#include <QDebug>
 
 
 static const char* SWITCHING_POLICIES[] = {"Global", "Desktop", "WinClass", "Window", NULL };
@@ -32,7 +36,6 @@ static const QString CONFIG_FILENAME("kxkbrc");
 static const QString CONFIG_GROUPNAME("Layout");
 
 
-
 static int findStringIndex(const char* strings[], const QString& toFind, int defaultIndex)
 {
 	for(int i=0; strings[i] != NULL; i++) {
@@ -144,3 +147,27 @@ void KeyboardConfig::save()
 
 	config.sync();
 }
+
+int KeyboardConfig::saveSystemWide()
+{
+
+    KAuth::Action action("org.kde.kcontrol.kcmkeyboard.managekeyboard");
+    action.setHelperID("org.kde.kcontrol.kcmkeyboard");
+
+    QVariantMap helperargs;
+    QStringList layoutList;
+    QStringList variantList;
+
+    foreach(const LayoutUnit& layoutUnit, layouts) {
+    	layoutList.append(layoutUnit.layout);
+    	variantList.append(layoutUnit.variant);
+    }
+
+    helperargs["layouts"] = layoutList.join(LIST_SEPARATOR);
+    helperargs["variants"] = variantList.join(LIST_SEPARATOR);
+
+    action.setArguments(helperargs);
+
+    KAuth::ActionReply reply = action.execute();
+    return reply.errorCode();
+}
diff --git a/kcontrol/keyboard/keyboard_config.h b/kcontrol/keyboard/keyboard_config.h
index bf5e0aa..10f0aa0 100644
--- a/kcontrol/keyboard/keyboard_config.h
+++ b/kcontrol/keyboard/keyboard_config.h
@@ -65,6 +65,7 @@ public:
 	void setDefaults();
 	void load();
 	void save();
+    int saveSystemWide();
 };
 
 #endif /* KEYBOARD_CONFIG_H_ */
-- 
1.7.3.2

